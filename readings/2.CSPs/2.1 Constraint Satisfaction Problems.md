## 2.1 约束满足问题（Constraint Satisfaction Problems）

在上一篇笔记中，我们学习了如何为**搜索问题**（一种规划问题）寻找最优解。现在，我们将学习解决一类相关的问题——**约束满足问题**（Constraint Satisfaction Problems，CSPs）。与搜索问题不同，CSP 是一种**识别问题**（identification problem），即我们只需要判断一个状态是否为目标状态，而不关心是如何到达该目标状态的。CSP 由以下三个要素定义：

- **变量（Variables）** —— CSP 拥有一组 $N$ 个变量 $X_1,\dots,X_N$，每个变量都可以从某个已定义的取值集合中取一个值。
- **取值域（Domain）** —— 一个集合 $\{x_1,\dots,x_d\}$，表示 CSP 中变量可能取到的所有值。
- **约束（Constraints）** —— 约束定义了变量取值上的限制，可能涉及与其他变量之间的关系。

考虑 **$N$ 皇后识别问题**：给定一个 $N\times N$ 的棋盘，是否能找到一种放置方式，在棋盘上放置 $N$ 个皇后，使得任意两个皇后都不会互相攻击？

![](../../image/2.CSPs/n-queens.png)

*N-queens problem*

我们可以将该问题表述为一个 CSP，如下所示：

- **变量** —— $X_{ij}$，其中 $0\le i,j<N$。每个 $X_{ij}$ 表示 $N\times N$ 棋盘上的一个格子位置，$i$ 和 $j$ 分别表示行号和列号。
- **取值域** —— $\{0,1\}$。每个 $X_{ij}$ 只能取 0 或 1，这是一个布尔值，用来表示在棋盘位置 $(i,j)$ 上是否存在一个皇后。
- **约束** ——  
  $$\forall i,j,k\ (X_{ij},X_{ik})\in\{(0,0),(0,1),(1,0)\}.$$
  该约束表示：如果两个变量具有相同的 $i$ 值，那么它们中最多只有一个可以取值为 1。这实际上刻画了“任意两个皇后不能在同一行上”的条件。

  $$\forall i,j,k\ (X_{ij},X_{kj})\in\{(0,0),(0,1),(1,0)\}.$$
  与前一个约束几乎完全相同，该约束表示：如果两个变量具有相同的 $j$ 值，那么它们中最多只有一个可以取值为 1，从而刻画了“任意两个皇后不能在同一列上”的条件。

  $$\forall i,j,k\ (X_{ij},X_{i+k,j+k})\in\{(0,0),(0,1),(1,0)\}.$$
  采用与上面类似的推理，可以看出该约束以及下一个约束分别表示：任意两个皇后不能位于同一条主对角线或副对角线上。

  $$\forall i,j,k\ (X_{ij},X_{i+k,j-k})\in\{(0,0),(0,1),(1,0)\}.$$

  $\sum_{i,j} X_{ij}=N.$
该约束表示：必须恰好有 $N$ 个棋盘位置被标记为 1，其余位置均标记为 0，从而刻画了“棋盘上恰好有 $N$ 个皇后”的要求。

约束满足问题是 **NP-hard** 的，这在宽泛意义上意味着：目前尚不存在一种已知的算法能够在多项式时间内求解所有 CSP。对于一个包含 $N$ 个变量、且每个变量的取值域大小为 $O(d)$ 的问题，一共有 $O(d^N)$ 种可能的赋值方式，其数量随变量个数呈指数级增长。我们通常可以通过将 CSP 表述为搜索问题来绕过这一限制：将**状态**定义为**部分赋值**（即对 CSP 变量进行赋值，其中部分变量已被赋值，部分变量尚未赋值）。相应地，CSP 状态的**后继函数**会输出所有“多给一个变量赋值”的新状态，而**目标测试**则用于验证：所有变量是否都已被赋值，且所有约束在被测试的状态中都得到了满足。约束满足问题往往比传统搜索问题具有更多的结构性，我们可以利用这种结构，将上述表述方式与合适的启发式方法结合起来，从而在可行的时间内找到解。

## 2.1.1 约束图（Constraint Graphs）

我们引入第二个 CSP 示例：**地图着色（map coloring）**。地图着色问题要求：给定一组颜色，对一张地图进行着色，使得任意两个相邻的州或区域不能使用相同的颜色。

![](../../image/2.CSPs/map-coloring-comic.png)

*Map coloring comic*

约束满足问题通常可以用**约束图**来表示，其中**节点**表示变量，**边**表示变量之间的约束。约束有多种不同类型，每一种的处理方式略有不同：

- **一元约束（Unary Constraints）** —— 一元约束只涉及 CSP 中的单个变量。它们通常不在约束图中显式表示，而是在需要时直接用于裁剪（prune）该变量的取值域。
- **二元约束（Binary Constraints）** —— 二元约束涉及两个变量。在约束图中，它们以传统图中的边来表示。
- **高阶约束（Higher-order Constraints）** —— 涉及三个或更多变量的约束也可以用 CSP 图中的边来表示，只是形式上看起来会稍微有些不寻常。

考虑对**澳大利亚地图**进行地图着色：

![](../../image/2.CSPs/australia-map.png)

*Map of Australia*

在该问题中，约束条件非常简单：任意两个相邻的州不能使用相同的颜色。因此，只要在每一对相邻州之间画一条边，我们就可以得到澳大利亚地图着色问题对应的约束图，如下所示：

![](../../image/2.CSPs/australia-graph.png)

*Constraint graph of Australia*

约束图的价值在于：我们可以利用它们来提取关于所求解 CSP 结构的重要信息。通过分析 CSP 的图结构，我们可以判断诸如：该问题是稀疏连接的还是密集连接的、是否具有树形结构等性质。随着我们对约束满足问题求解方法的进一步讨论，这些内容将被更深入地展开。
