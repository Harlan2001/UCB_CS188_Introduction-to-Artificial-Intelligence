## 2.3 过滤（Filtering）













我们将考虑提升 CSP 求解性能的第一个改进方法——**过滤（filtering）**。过滤的目标是在提前阶段检查是否可以通过移除那些**必然会导致回溯**的取值，从而裁剪尚未赋值变量的取值域。

一种朴素的过滤方法是**前向检查（forward checking）**。当前向检查中，每当一个值被赋给某个变量 $X_i$ 时，就会裁剪所有**尚未赋值**且与 $X_i$ 共享约束的变量的取值域，移除那些一旦赋值就会违反约束的取值。每当有一个新变量被赋值时，我们都可以运行前向检查，并在约束图中对与该新赋值变量相邻的、尚未赋值的变量进行取值域裁剪。考虑地图着色的示例，其中包含尚未赋值的变量及其可能的取值：

![](../../image/2.CSPs/forward-checking.png)

*Forward checking example*

注意，当我们依次赋值 $WA = red$，然后赋值 $Q = green$ 时，$NT$、$NSW$ 和 $SA$（与 $WA$、$Q$ 或二者相邻的州）的取值域大小随着某些取值被消除而逐渐减小。

前向检查的思想可以推广为**弧一致性（arc consistency）**原则。在弧一致性中，我们将 CSP 约束图中的每一条无向边解释为两条方向相反的有向边。每一条这样的有向边被称为一条**弧（arc）**。弧一致性算法的工作流程如下：

1. 首先，将 CSP 约束图中的所有弧存入一个队列 $Q$。
2. 反复从 $Q$ 中取出弧，并对取出的每一条弧 $X_i \rightarrow X_j$ 强制执行如下条件：  
   对于尾变量 $X_i$ 的每一个剩余取值 $v$，都必须至少存在一个头变量 $X_j$ 的剩余取值 $w$，使得 $X_i = v, X_j = w$ 不违反任何约束。  
   如果对于 $X_i$ 的某个取值 $v$，不存在任何一个与 $X_j$ 的剩余取值相容的 $w$，那么就将 $v$ 从 $X_i$ 的取值集合中移除。
3. 如果在对某条弧 $X_i \rightarrow X_j$ 强制弧一致性时，从 $X_i$ 的取值域中至少移除了一个取值，那么就将所有形如 $X_k \rightarrow X_i$ 的弧加入队列 $Q$，其中 $X_k$ 为尚未赋值的变量。若某条弧 $X_k \rightarrow X_i$ 已经在队列 $Q$ 中，则无需再次加入。
4. 持续该过程，直到 $Q$ 为空，或者某个变量的取值域被裁剪为空，从而触发一次回溯。

弧一致性算法通常并不是最直观的，因此我们通过一个地图着色的简单示例来说明其工作过程：

![](../../image/2.CSPs/arc-consistency-ex-1.png)

*Arc consistency example*

我们首先将所有在约束图中、共享约束的未赋值变量之间的弧加入队列 $Q$，得到：

$$
Q = [SA \rightarrow V,\ V \rightarrow SA,\ SA \rightarrow NSW,\ NSW \rightarrow SA,\ SA \rightarrow NT,\ NT \rightarrow SA,\ V \rightarrow NSW,\ NSW \rightarrow V]
$$

对于第一条弧 $SA \rightarrow V$，我们可以看到，对于 $SA$ 取值域中的每一个取值 $\{blue\}$，在 $V$ 的取值域 $\{red, green, blue\}$ 中，都至少存在一个不违反任何约束的取值，因此无需从 $SA$ 的取值域中裁剪任何值。然而，对于下一条弧 $V \rightarrow SA$，如果我们令 $V = blue$，就会发现 $SA$ 不再有任何不违反约束的可行取值，因此我们需要将 $blue$ 从 $V$ 的取值域中移除。

![](../../image/2.CSPs/arc-consistency-ex-2.png)

*Arc consistency example 2*

由于我们从 $V$ 的取值域中裁剪了一个取值，因此需要将所有以 $V$ 为头节点的弧加入队列，即 $SA \rightarrow V$、$NSW \rightarrow V$。由于 $NSW \rightarrow V$ 已经在队列 $Q$ 中，因此只需加入 $SA \rightarrow V$，此时更新后的队列为：

$$
Q = [SA \rightarrow NSW,\ NSW \rightarrow SA,\ SA \rightarrow NT,\ NT \rightarrow SA,\ V \rightarrow NSW,\ NSW \rightarrow V,\ SA \rightarrow V]
$$

我们可以继续这一过程，直到最终从 $Q$ 中取出弧 $SA \rightarrow NT$。在该弧上强制执行弧一致性会将 $blue$ 从 $SA$ 的取值域中移除，使其取值域变为空，从而触发一次回溯。注意，在队列 $Q$ 中，弧 $NSW \rightarrow SA$ 出现在 $SA \rightarrow NT$ 之前，而在对该弧强制一致性时，会将 $blue$ 从 $NSW$ 的取值域中移除。

![](../../image/2.CSPs/arc-consistency-ex-3.png)

*Arc consistency example 3*

弧一致性通常通过 **AC-3 算法**（Arc Consistency Algorithm #3）来实现，其伪代码如下所示：

![](../../image/2.CSPs/arc-consistency-pseudo.png)

*AC-3 pseudocode*

AC-3 算法在最坏情况下的时间复杂度为 $O(ed^3)$，其中 $e$ 表示弧（有向边）的数量，$d$ 表示最大取值域的大小。总体而言，与前向检查相比，弧一致性是一种更加**整体化**的取值域裁剪技术，能够显著减少回溯次数，但其代价是需要进行更多的计算来维持一致性。因此，在为具体的 CSP 选择过滤技术时，必须权衡这种性能提升与计算开销之间的取舍。

作为关于一致性的一个有趣补充说明，弧一致性只是更一般的一致性概念——**$k$-一致性（k-consistency）**——的一个特例。当强制执行 $k$-一致性时，可以保证：对于 CSP 中任意一组 $k$ 个节点，只要其中任意 $k-1$ 个节点存在一个一致的赋值，那么第 $k$ 个节点一定至少存在一个一致的取值。该思想还可以进一步推广为**强 $k$-一致性（strong k-consistency）**。一个强 $k$-一致的图不仅是 $k$-一致的，同时也是 $k-1, k-2, \dots, 1$-一致的。不出所料，对 CSP 施加更高程度的一致性，其计算代价也会更高。在这一广义一致性定义下，我们可以看到，**弧一致性等价于 $2$-一致性**。
