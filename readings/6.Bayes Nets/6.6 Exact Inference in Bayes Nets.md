## 6.6 贝叶斯网中的精确推断

推断是寻找某个概率分布值的问题：

\[
P(Q_1, \dots, Q_k \mid e_1, \dots, e_k)
\]

如前面概率推断部分所述，给定一个贝叶斯网，我们可以通过构建联合 PDF 并使用枚举推断来简单解决这个问题，但这需要创建并迭代一个指数级大的表。

---

### 6.6.1 变量消去（Variable Elimination）

另一种方法是逐一消除隐藏变量。以消除一个变量 \(X\) 为例，我们：

1. 将所有涉及 \(X\) 的因子相乘。
2. 对 \(X\) 求和（marginalize）。

> 因子（factor）被定义为未归一化的概率。在变量消去的每个阶段，每个因子都与其对应的概率成正比，但不保证加和为 1。  

变量消去伪代码如下：

![](../../image/6.BayesNets/VarElim.png)

**Variable Elimination**

---

### 示例

![](../../image/6.BayesNets/another_bayes_nets.png)


假设我们有如下模型，其中 \(T, C, S, E\) 都是二元变量：

- \(T\) ：冒险者获得宝藏的概率  
- \(C\) ：冒险者拿走宝藏时，笼子落在他们身上的概率  
- \(S\) ：冒险者获得宝藏时蛇被释放的概率  
- \(E\) ：冒险者在获得笼子和蛇的状态信息后逃脱的概率  

此时有因子：

\[
P(T),\quad P(C \mid T),\quad P(S \mid T),\quad P(E \mid C, S)
\]

假设我们想计算 \(P(T \mid +e)\)。  
通过枚举推断，需要形成 16 行的联合 PDF：

\[
P(T, C, S, E)
\]

然后选择对应于 \(+e\) 的行，对 \(C\) 和 \(S\) 求和，最后归一化。

---

### 变量消去方法

先消除 \(C\)，再消除 \(S\)，一次一个变量：

1. **合并涉及 \(C\) 的因子**：

\[
f_1(C, +e, T, S) = P(C \mid T) \cdot P(+e \mid C, S)
\]

有时写作 \(P(C, +e \mid T, S)\)。

2. **对 \(C\) 求和**：

\[
f_2(+e, T, S) \quad \text{(有时写作 } P(+e \mid T, S) \text{)}
\]

3. **合并涉及 \(S\) 的因子**：

\[
F_3(+e, S, T) = P(S \mid T) \cdot f_2(+e, T, S) \quad \text{(有时写作 } P(+e, S \mid T) \text{)}
\]

4. **对 \(S\) 求和**：

\[
f_4(+e, T) \quad \text{(有时写作 } P(+e \mid T) \text{)}
\]

5. **合并剩余因子**：

\[
f_5(+e, T) = f_4(+e, T) \cdot P(T)
\]

最终可以通过归一化计算：

\[
P(T \mid +e)
\]

---

### 因子表示法说明

- 写作 \(f_1(C, +e, T, S)\) 时忽略条件条，仅提供包含的变量列表。  
- 也可以写作 \(P(C, +e \mid T, S)\)，即使不保证是有效概率分布（行和可能不为 1）。  
- 表达式生成规则：原始因子中条件条左侧的所有变量保持在左侧，其余变量放在右侧。

例如，上述模型：

\[
\begin{aligned}
P(T, C, S, +e) &= P(T) P(S \mid T) P(C \mid T) P(+e \mid C, S) \\
&= P(S, T) P(C \mid T) P(+e \mid C, S)
\end{aligned}
\]

因此：

\[
P(C \mid T) P(+e \mid C, S) = P(T, C, S, +e) / P(S, T) = P(C, +e \mid T, S)
\]

---

### 变量消去的效率

- 变量消去生成的任何因子最大行数为 8 行，而形成整个联合 PDF 需要 16 行。  
- 另一种看法，计算 \(P(T \mid +e)\)：

**枚举推断方式**：

\[
\alpha \sum_s \sum_c P(T) P(s \mid T) P(c \mid T) P(+e \mid c, s)
\]

**变量消去方式**：

\[
\alpha P(T) \sum_s P(s \mid T) \sum_c P(c \mid T) P(+e \mid c, s)
\]

两者等价，只是变量消去中提前移动了与求和无关的项，减少了计算量。

> 注意：只有当最大因子大小可以保持在合理范围时，变量消去才比枚举推断更高效。
