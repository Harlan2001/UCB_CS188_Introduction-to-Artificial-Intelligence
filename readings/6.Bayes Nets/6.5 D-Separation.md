# 6.5 D-分离（D-Separation）

关于一组随机变量，一个有用的问题是：一个变量是否独立于另一个变量，或者一个随机变量在已知第三个随机变量的情况下是否条件独立于另一个变量。贝叶斯网络表示联合概率分布为我们提供了一种通过检查图的拓扑结构快速回答此类问题的方法。

我们已经提到，节点在已知其所有父节点的条件下，对图中所有祖先节点条件独立。

下面我们将介绍三节点两边的贝叶斯网络（或称三元组）的三种典型情况，以及它们表达的条件独立关系。

---

## 6.5.1 因果链（Causal Chains）

**因果链无观测**  
![](../../image/6.BayesNets/chain_free.png)
图 1：因果链无观测

**因果链 Y 被观测**  
![](../../image/6.BayesNets/chain_observed.png)
图 2：因果链 Y 被观测

图 1 是由三个节点组成的配置，称为因果链。它表示 \(X, Y, Z\) 的联合分布如下：

\[
P(x,y,z) = P(z \mid y) P(y \mid x) P(x)
\]

需要注意的是，\(X\) 和 \(Z\) 不保证独立，如下反例所示：

\[
P(y \mid x) =
\begin{cases}
1 & \text{如果 } x=y \\
0 & \text{否则}
\end{cases}
\quad
P(z \mid y) =
\begin{cases}
1 & \text{如果 } z=y \\
0 & \text{否则}
\end{cases}
\]

在这种情况下，

\[
P(z \mid x) = 
\begin{cases}
1 & \text{如果 } x=z \\
0 & \text{否则}
\end{cases}
\]

所以 \(X\) 和 \(Z\) 并不独立。

---

然而，我们可以断言：

\[
X \perp\!\!\!\perp Z \mid Y
\]

如图 2 所示。回忆这个条件独立意味着：

\[
P(X \mid Z, Y) = P(X \mid Y)
\]

我们可以如下证明：

\[
\begin{aligned}
P(X \mid Z, y) &= \frac{P(X,Z,y)}{P(Z,y)} \\
&= \frac{P(Z \mid y) P(y \mid X) P(X)}{\sum_x P(x,y,Z)} \\
&= \frac{P(Z \mid y) P(y \mid X) P(X)}{P(Z \mid y) \sum_x P(y \mid x) P(x)} \\
&= \frac{P(y \mid X) P(X)}{\sum_x P(y \mid x) P(x)} \\
&= P(X \mid y)
\end{aligned}
\]

同样的证明可以用于 \(X\) 有多个父节点的情况。总结而言，在因果链配置中：

\[
X \perp\!\!\!\perp Z \mid Y
\]

## 6.5.2 共同原因（Common Cause）

**共同原因无观测**  
![](../../image/6.BayesNets/cause_free.png)
图 3：共同原因无观测

**共同原因 Y 被观测**  
![](../../image/6.BayesNets/cause_observed.png)
图 4：共同原因 Y 被观测

三节点另一种可能的配置是共同原因（Common Cause）。它表示联合分布如下：

\[
P(x,y,z) = P(x \mid y) P(z \mid y) P(y)
\]

就像因果链一样，我们可以通过以下反例分布显示 \(X\) 并不保证独立于 \(Z\)：

\[
P(x \mid y) =
\begin{cases}
1 & \text{如果 } x=y \\
0 & \text{否则}
\end{cases}
\quad
P(z \mid y) =
\begin{cases}
1 & \text{如果 } z=y \\
0 & \text{否则}
\end{cases}
\]

此时，

\[
P(x \mid z) = 
\begin{cases}
1 & \text{如果 } x=z \\
0 & \text{否则}
\end{cases}
\]

因此 \(X\) 和 \(Z\) 并不独立。

但是可以断言：

\[
X \perp\!\!\!\perp Z \mid Y
\]

也就是说，如果 \(Y\) 被观测（如图 4），则 \(X\) 和 \(Z\) 条件独立。证明如下：

\[
\begin{aligned}
P(X \mid Z, y) &= \frac{P(X,Z,y)}{P(Z,y)} \\
&= \frac{P(X \mid y) P(Z \mid y) P(y)}{P(Z \mid y) P(y)} \\
&= P(X \mid y)
\end{aligned}
\]

---

## 6.5.3 共同效应（Common Effect）

**共同效应无观测**  
![](../../image/6.BayesNets/effect_free.png)
图 5：共同效应无观测

**共同效应 Y 被观测**  
![](../../image/6.BayesNets/effect_observed.png)
图 6：共同效应 Y 被观测

其联合分布表示为：

\[
P(x,y,z) = P(y \mid x,z) P(x) P(z)
\]

在图 5 所示的配置中，\(X\) 和 \(Z\) 是独立的：

\[
X \perp\!\!\!\perp Z
\]

然而，当条件为 \(Y\) 时，它们不一定独立（图 6）。例如，假设三者都是二元变量，\(X\) 和 \(Z\) 以相等概率为真或假：

\[
P(X = \text{true}) = P(X = \text{false}) = 0.5
\]

\[
P(Z = \text{true}) = P(Z = \text{false}) = 0.5
\]

而 \(Y\) 由 \(X\) 和 \(Z\) 是否相等决定：

\[
P(Y \mid X,Z) =
\begin{cases}
1 & \text{如果 } X=Z \text{ 且 } Y=\text{true} \\
1 & \text{如果 } X \neq Z \text{ 且 } Y=\text{false} \\
0 & \text{否则}
\end{cases}
\]

此时，若 \(Y\) 未观测，\(X\) 和 \(Z\) 独立；若 \(Y\) 被观测，知道 \(X\) 的值就能推知 \(Z\) 的值，反之亦然。因此，在已知 \(Y\) 的条件下，\(X\) 和 \(Z\) 并不条件独立。

---

共同效应可以被视为与因果链和共同原因相“相反”——如果不对 \(Y\) 进行条件化，\(X\) 和 \(Z\) 保证独立；但是当条件化于 \(Y\) 时，\(X\) 和 \(Z\) 可能相关，这取决于 \(P(Y \mid X,Z)\) 的具体概率值。

同样的逻辑适用于对图中 \(Y\) 的后代节点进行条件化。如果观测到 \(Y\) 的一个后代节点，如图 7 所示，则 \(X\) 和 \(Z\) 不保证独立。

**共同效应观测子节点**  
![](../../image/6.BayesNets/effect_children.png)
图 7：共同效应观测子节点

## 6.5.4 一般情况与 D-分离（D-Separation）

我们可以将前面三种情况作为构建模块，用来回答任意包含超过三节点和两条边的贝叶斯网络中的条件独立问题。我们将问题表述如下：

> 给定一个贝叶斯网络 \(G\)，两个节点 \(X\) 和 \(Y\)，以及一个（可能为空的）节点集合 \(\{Z_1, \dots, Z_k\}\) 表示观测变量，是否必须成立：
>
> \[
> X \perp\!\!\!\perp Y \mid \{Z_1, \dots, Z_k\} ?
> \]

D-分离（Directed Separation）是贝叶斯网络图结构的一个性质，它暗示这种条件独立关系，并且概括了我们之前看到的情况。如果变量集合 \(Z_1, \dots, Z_k\) **D-分离** \(X\) 和 \(Y\)，那么在贝叶斯网络所能编码的所有可能分布中都有：

\[
X \perp\!\!\!\perp Y \mid \{Z_1, \dots, Z_k\}
\]

---

### 基于可达性的初步算法

1. 将图中所有观测节点 \(\{Z_1, \dots, Z_k\}\) 着色（标记）。
2. 检查 \(X\) 到 \(Y\) 是否存在一条未被着色节点阻断的无向路径：
   - 如果存在，则 \(X\) 和 \(Y\) “连接”。
   - 如果 \(X\) 和 \(Y\) 连接，它们在给定 \(\{Z_1, \dots, Z_k\}\) 条件下不独立；否则，它们独立。
   
> 注意：该算法只在贝叶斯网络中不存在共同效应结构时有效，因为如果存在共同效应结构，当 Y 节点被观测时，两节点会被“可达”。  

---

### D-分离算法（修正版）

1. 将图中所有观测节点 \(\{Z_1, \dots, Z_k\}\) 着色。
2. 枚举 \(X\) 到 \(Y\) 的所有无向路径。
3. 对于每条路径：
   1. 将路径分解为三元组（连续三节点与两条边）。
   2. 如果所有三元组都是活跃的，则路径活跃并 **D-连接** \(X\) 与 \(Y\)。
4. 如果没有路径 D-连接 \(X\) 和 \(Y\)，则：

\[
X \perp\!\!\!\perp Y \mid \{Z_1, \dots, Z_k\}
\]

---

### 三元组规则

- 图中从 \(X\) 到 \(Y\) 的任意路径可以分解为连续三个节点和两条边的三元组。  
- 三元组是否活跃取决于中间节点是否被观测。  
- 若路径中所有三元组均活跃，则路径活跃，D-连接 \(X\) 与 \(Y\)，意味着 \(X\) 在给定观测节点下不保证独立于 \(Y\)。  
- 若 \(X\) 到 \(Y\) 的所有路径均不活跃，则 \(X\) 与 \(Y\) 在给定观测节点下条件独立。

活跃三元组和非活跃三元组可以通过我们之前介绍的三种典型图进行枚举。

![](../../image/6.BayesNets/active.png)

![](../../image/6.BayesNets/inactive.png)
---

## 6.5.5 示例

以下是应用 D-分离算法的一些示例：

### 示例 1

此图包含共同效应和因果链的典型图：

![](../../image/6.BayesNets/rbtt.png)

- \(R \perp\!\!\!\perp B\) – 保证独立  
- \(R \perp\!\!\!\perp B \mid T\) – 不保证  
- \(R \perp\!\!\!\perp B \mid T'\) – 不保证  
- \(R \perp\!\!\!\perp T' \mid T\) – 保证独立  

---

### 示例 2

此图包含所有三种典型图的组合：

![](../../image/6.BayesNets/lrbdtt.png)

- \(L \perp\!\!\!\perp T' \mid T\) – 保证独立  
- \(L \perp\!\!\!\perp B\) – 保证独立  
- \(L \perp\!\!\!\perp B \mid T\) – 不保证  
- \(L \perp\!\!\!\perp B \mid T'\) – 不保证  
- \(L \perp\!\!\!\perp B \mid T, R\) – 保证独立  

---

### 示例 3

此图包含所有三种典型图的组合：

![](../../image/6.BayesNets/rtds.png)

- \(T \perp\!\!\!\perp D\) – 不保证  
- \(T \perp\!\!\!\perp D \mid R\) – 保证独立  
- \(T \perp\!\!\!\perp D \mid R, S\) – 不保证

