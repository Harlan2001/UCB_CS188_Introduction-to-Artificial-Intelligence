# 8.4 粒子滤波 (Particle Filtering)

回想一下，在贝叶斯网络中，当运行精确推理过于耗费计算资源时，使用我们讨论过的采样技术是一种可行的替代方法，可以高效地近似我们想要的概率分布。  
隐藏马尔可夫模型同样存在这个缺点——使用前向算法运行精确推理的时间会随着随机变量取值域大小的增加而增长。  
在当前的天气问题中，这可以接受，因为天气只有两个可能值

$$ W_i ∈ {sun, rain} $$

但如果我们想计算某一天的实际温度分布，精确到十分之一度，这种方法就不可行了。

隐藏马尔可夫模型中对应贝叶斯网络采样的方法称为粒子滤波 (particle filtering)，它通过模拟一组粒子在状态图中的运动来近似随机变量的概率（信念）分布。  
这解决了与前向算法相同的问题：它给出了$ P(X_N | e_1:N) $的近似。

与其存储完整的概率表将每个状态映射到其信念概率，不如存储一个粒子列表，共 n 个粒子，每个粒子位于时间相关随机变量的 d 个可能状态之一。  
通常 n 显著小于 d（符号表示为 n << d），但仍足够大以提供有意义的近似；否则粒子滤波的性能优势将几乎消失。  
在这个算法中，粒子就是样本的意思。

在任何给定时间步，粒子处于某一状态的信念完全依赖于模拟中该时间步该状态的粒子数量。  
例如，假设我们想模拟某一天 i 的温度 T 的信念分布，为简单起见，假设温度只能取整数值，范围为 [10, 20]（d = 11 个可能状态）。  
进一步假设我们有 n = 10 个粒子，在模拟的时间步 i 的取值如下：

$$
[15, 12, 12, 10, 18, 14, 12, 11, 11, 10]
$$

通过统计粒子列表中每个温度出现的次数，并除以粒子总数，我们可以生成所需的温度经验分布：

| T_i  | 10  | 11  | 12  | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 |
|------|-----|-----|-----|----|----|----|----|----|----|----|----|
| B(T_i) | 0.2 | 0.2 | 0.3 | 0  | 0.1| 0.1| 0  | 0  | 0.1| 0  | 0  |

现在我们已经看到如何从粒子列表恢复信念分布，剩下需要讨论的是如何为任意时间步生成这样的粒子列表。

---

## 8.4.1 粒子滤波模拟 (Particle Filtering Simulation)

粒子滤波模拟从粒子初始化开始，这一步可以相当灵活——我们可以随机采样粒子、均匀采样，或者从某个初始分布采样。  
一旦我们采样出初始粒子列表，模拟就类似于前向算法，在每个时间步依次进行 **时间推进更新 (Time Elapse Update)** 和 **观测更新 (Observation Update)**：

- **时间推进更新 (Time Elapse Update)** — 根据转移模型更新每个粒子的值。  
  对于处于状态 \(t_i\) 的粒子，从概率分布 \(P(T_{i+1} \mid t_i)\) 中采样更新后的值。  
  注意时间推进更新与贝叶斯网络中的先验采样的相似性，因为某一状态下粒子的频率反映了转移概率。

- **观测更新 (Observation Update)** — 使用传感器模型 \(P(F_i \mid T_i)\) 对每个粒子根据观测证据和粒子状态赋权。  
  对于处于状态 \(t_i\) 且传感器读数为 \(f_i\) 的粒子，赋予权重：
  \[
  w_i = P(f_i \mid t_i)
  \]
  观测更新算法如下：
  1. 计算所有粒子的权重 \(w_i\)。
  2. 计算每个状态的总权重。
  3. 如果所有状态的权重和为 0，则重新初始化所有粒子。
  4. 否则，将总权重在各状态上归一化，并根据该分布重新采样粒子列表。  

注意观测更新与 **似然加权 (likelihood weighting)** 的相似性，我们再次根据证据对样本进行降权。

---

为了更好理解这个过程，以示例说明。定义一个温度作为时间相关随机变量的天气转移模型：  
对于某一温度状态，可以保持在当前状态，或者转移到相差一度的状态，范围在 \([10, 20]\) 内。  
在可能的结果状态中，转移到最接近 15 的状态的概率为 0.8，其余状态均匀分配剩余的 0.2 概率。

假设温度粒子列表为：

\[
[15, 12, 12, 10, 18, 14, 12, 11, 11, 10]
\]

对列表中的第一个粒子 \(T_i = 15\) 执行时间推进更新，需要对应的转移模型：

| \(T_{i+1}\) | 14  | 15  | 16  |
|--------------|-----|-----|-----|
| \(P(T_{i+1} \mid T_i=15)\) | 0.1 | 0.8 | 0.1 |

实际操作中，我们为 \(T_{i+1}\) 的每个取值分配区间，使这些区间完整覆盖 \([0,1)\) 且不重叠。区间如下：

- \(T_{i+1} = 14\)：\(0 \le r < 0.1\)
- \(T_{i+1} = 15\)：\(0.1 \le r < 0.9\)
- \(T_{i+1} = 16\)：\(0.9 \le r < 1\)

重新采样时，生成随机数 \(r \in [0,1)\)，判断落入哪个区间。  
例如 \(r = 0.467\) 则粒子保持在 \(T_{i+1} = 15\)，因为 \(0.1 \le r < 0.9\)。

随机数列表（用于 10 个粒子）：

\[
[0.467, 0.452, 0.583, 0.604, 0.748, 0.932, 0.609, 0.372, 0.402, 0.026]
\]

重新采样后粒子列表：

\[
[15, 13, 13, 11, 17, 15, 13, 12, 12, 10]
\]

对应的信念分布 \(B(T_{i+1})\)：

| \(T_i\) | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  | 19  | 20  |
|----------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| \(B(T_{i+1})\) | 0.1 | 0.1 | 0.2 | 0.3 | 0   | 0.2 | 0   | 0.1 | 0   | 0   | 0   |

与初始信念分布 \(B(T_i)\) 对比，可见粒子总体趋势聚集到 \(T=15\)。

---

观测更新：假设传感器模型 \(P(F_i \mid T_i)\) 表示预测正确 (\(f_i = t_i\)) 的概率为 0.8，其余 10 个状态均匀为 0.02。  
观测 \(F_{i+1} = 13\) 时粒子权重：

| 粒子 | p1  | p2  | p3  | p4  | p5  | p6  | p7  | p8  | p9  | p10 |
|-------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| 状态  | 15  | 13  | 13  | 11  | 17  | 15  | 13  | 12  | 12  | 10  |
| 权重  | 0.02| 0.8 | 0.8 | 0.02| 0.02| 0.02| 0.8 | 0.02| 0.02| 0.02|

按状态聚合权重：

| 状态 | 10  | 11  | 12  | 13  | 15  | 17  |
|-------|-----|-----|-----|-----|-----|-----|
| 权重  | 0.02| 0.02| 0.04| 2.4 | 0.04| 0.02|

权重和为 \(2.54\)，归一化：

| 状态 | 10      | 11      | 12      | 13      | 15      | 17      |
|-------|---------|---------|---------|---------|---------|---------|
| 归一化权重 | 0.0079  | 0.0079  | 0.0157  | 0.9449  | 0.0157  | 0.0079 |

重新采样粒子列表，生成随机数：

\[
[0.315, 0.829, 0.304, 0.368, 0.459, 0.891, 0.282, 0.980, 0.898, 0.341]
\]

最终粒子列表：

\[
[13, 13, 13, 13, 13, 13, 13, 15, 13, 13]
\]

对应信念分布：

| \(T_i\) | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  | 19  | 20  |
|----------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| \(B(T_{i+1})\) | 0   | 0   | 0   | 0.9 | 0   | 0.1 | 0   | 0   | 0   | 0   | 0   |

可见，传感器模型反映天气预测准确（80%），新粒子列表大部分聚集到 \(T_{i+1} = 13\)。


