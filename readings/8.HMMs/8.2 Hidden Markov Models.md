### 8.2 隐马尔可夫模型（Hidden Markov Models, HMM）

在普通马尔可夫模型中，我们通过一系列随机变量来刻画随时间的变化。例如，如果想预测第 10 天的天气，可以从初始分布 \(P(W_0)\) 出发，使用 mini-forward 算法和转移模型计算 \(P(W_{10})\)。  

然而，在时间 \(t=0\) 到 \(t=10\) 之间，我们可能会收集新的气象证据，这些证据会影响对任意时间步天气分布的信念。比如，第 10 天预测降雨概率为 80%，但第 9 天夜晚天空晴朗，那么第 10 天降雨概率可能会大幅下降。**隐马尔可夫模型（HMM）**正是为处理这种情况而设计的——它允许在每个时间步观察证据，从而更新对各状态的信念分布。

![](../../image/8.HMMs/weather-markov.png)
---

#### HMM 的结构

HMM 可以用贝叶斯网络表示，区别于普通马尔可夫模型：

1. **状态变量** \(W_i\)：表示第 \(i\) 天的天气。
2. **证据变量** \(F_i\)：表示第 \(i\) 天的天气观测或预测。

条件依赖关系：

\[
\begin{aligned}
F_1 &\perp W_0 \mid W_1 \\
\forall i=2,\dots,n: \quad W_i &\perp \{W_0, \dots, W_{i-2}, F_1, \dots, F_{i-1}\} \mid W_{i-1} \\
F_i &\perp \{W_0, \dots, W_{i-1}, F_1, \dots, F_{i-1}\} \mid W_i
\end{aligned}
\]

类似马尔可夫模型，HMM 假设**转移模型平稳**：

\[
P(W_{i+1} \mid W_i) \text{ 相同}
\]

此外，HMM 假设**观测模型平稳**：

\[
P(F_i \mid W_i) \text{ 相同}
\]

因此，一个 HMM 可以用三个概率表紧凑表示：

1. 初始分布 \(P(W_0)\)
2. 转移模型 \(P(W_{i+1} \mid W_i)\)
3. 传感器（观测）模型 \(P(F_i \mid W_i)\)

---

#### 信念分布（Belief Distribution）

- **全证据下的信念**：

\[
B(W_i) = P(W_i \mid f_1, \dots, f_i)
\]

- **缺少当前时间证据的信念**：

\[
B'(W_i) = P(W_i \mid f_1, \dots, f_{i-1})
\]

有时将 1 到 t 步的证据聚合记作：

\[
e_{1:t} = e_1, \dots, e_t
\]

在此记法下：

\[
P(W_i \mid f_1, \dots, f_{i-1}) = P(W_i \mid f_{1:(i-1)})
\]

这种表示方式将在后续“时间推进更新（time elapse update）”中非常重要，用于迭代地将新证据融入天气模型。

#### 8.2.1 前向算法（The Forward Algorithm）

利用前节 HMM 的条件概率假设和条件概率表的边缘化性质，我们可以推导出 **信念分布 \(B(W_i)\) 与 \(B'(W_{i+1})\) 的关系**，形式与 mini-forward 算法的更新规则相同。

---

#### 时间推进更新（Time Elapse Update）

从边缘化开始：

\[
B'(W_{i+1}) = P(W_{i+1} \mid f_1, \dots, f_i) = \sum_{w_i} P(W_{i+1}, w_i \mid f_1, \dots, f_i)
\]

使用链式法则：

\[
B'(W_{i+1}) = \sum_{w_i} P(W_{i+1} \mid w_i, f_1, \dots, f_i) \, P(w_i \mid f_1, \dots, f_i)
\]

注意到 \(P(w_i \mid f_1, \dots, f_i) = B(w_i)\)，且 \(W_{i+1} \perp \{f_1, \dots, f_i\} \mid W_i\)，于是简化为：

\[
\boxed{B'(W_{i+1}) = \sum_{w_i} P(W_{i+1} \mid w_i) \, B(w_i)}
\]

这就是**时间推进更新**的公式。

---

#### 观测更新（Observation Update）

定义观测更新：

\[
B(W_{i+1}) = P(W_{i+1} \mid f_1, \dots, f_{i+1}) = \frac{P(W_{i+1}, f_{i+1} \mid f_1, \dots, f_i)}{P(f_{i+1} \mid f_1, \dots, f_i)}
\]

通常使用**延迟归一化技巧**，先忽略分母，得到：

\[
B(W_{i+1}) \propto P(W_{i+1}, f_{i+1} \mid f_1, \dots, f_i)
\]

利用链式法则和条件独立性：

\[
B(W_{i+1}) \propto P(f_{i+1} \mid W_{i+1}) \, P(W_{i+1} \mid f_1, \dots, f_i) = P(f_{i+1} \mid W_{i+1}) \, B'(W_{i+1})
\]

---

#### 前向算法迭代公式

将时间推进更新与观测更新结合，即得到 **前向算法（Forward Algorithm）**：

\[
\boxed{B(W_{i+1}) \propto P(f_{i+1} \mid W_{i+1}) \sum_{w_i} P(W_{i+1} \mid w_i) \, B(w_i)}
\]

步骤说明：

1. **时间推进更新**：从 \(B(W_i) \to B'(W_{i+1})\)
2. **观测更新**：从 \(B'(W_{i+1}) \to B(W_{i+1})\)

---

#### 示例计算

给定初始分布、转移模型和观测模型：

| W0 | B(W0) |
|----|-------|
| sun | 0.8 |
| rain | 0.2 |

| $W_{i+1}$ | $W_i$ | $P(W_{i+1} \mid W_i)$ |
|------------|--------|------------------------|
| sun        | sun    | 0.6                    |
| rain       | sun    | 0.4                    |
| sun        | rain   | 0.1                    |
| rain       | rain   | 0.9                    |

| $F_i$ | $W_i$ | $P(F_i \mid W_i)$ |
|--------|--------|--------------------|
| good   | sun    | 0.8                |
| bad    | sun    | 0.2                |
| good   | rain   | 0.3                |
| bad    | rain   | 0.7                |


**时间推进更新**：

\[
\begin{aligned}
B'(W_1 = sun) &= 0.6 \cdot 0.8 + 0.1 \cdot 0.2 = 0.5 \\
B'(W_1 = rain) &= 0.4 \cdot 0.8 + 0.9 \cdot 0.2 = 0.5
\end{aligned}
\]

**观测更新**（假设 \(F_1 = good\)）：

\[
\begin{aligned}
B(W_1 = sun) &\propto 0.8 \cdot 0.5 = 0.4 \\
B(W_1 = rain) &\propto 0.3 \cdot 0.5 = 0.15
\end{aligned}
\]

归一化：

\[
B(W_1 = sun) = \frac{0.4}{0.55} = \frac{8}{11}, \quad B(W_1 = rain) = \frac{0.15}{0.55} = \frac{3}{11}
\]

结果表：

| $W_1$ | $B(W_1)$ |
|--------|-----------|
| sun    | $\frac{8}{11}$ |
| rain   | $\frac{3}{11}$ |


观察预测后，晴天的信念从时间推进更新后的 1/2 提升至 8/11。

> **提示**：延迟归一化技巧可显著简化 HMM 的计算。若需要计算 \(B(W_t)\)，可以迭代使用前向算法，最后再统一归一化。

